{% extends "base.html" %}

{% block title %}ë³‘ì› ëª©ë¡ - ë³´í›ˆ ë³‘ì› ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block content %}
<div class="hospitals-page">
    <!-- ì—°ë„ë³„, ì§€ìì²´ë³„ ìœ„íƒë³‘ì›ìˆ˜ í˜„í™© ì°¨íŠ¸ (Grafana ìŠ¤íƒ€ì¼) -->
    <div class="chart-section grafana-style">
        <div class="chart-header">
            <h2>ğŸ“Š ì—°ë„ë³„, ì§€ìì²´ë³„ ìœ„íƒë³‘ì›ìˆ˜ í˜„í™©</h2>
            <div class="chart-info">
                <span class="data-source">ğŸ“‚ testdb.ìœ„íƒë³‘ì›í˜„í™©_ì—°ë„ë³„í˜„í™©</span>
            </div>
        </div>
        
        <!-- íŒŒì´ ì°¨íŠ¸ 3ê°œ (ì—°ë„ë³„) -->
        <div class="pie-charts-row">
            <div class="pie-chart-card">
                <h3>2022ë…„ë„ íŒŒì´ ì°¨íŠ¸</h3>
                <canvas id="pieChart2022"></canvas>
            </div>
            <div class="pie-chart-card">
                <h3>2023ë…„ë„ íŒŒì´ ì°¨íŠ¸</h3>
                <canvas id="pieChart2023"></canvas>
            </div>
            <div class="pie-chart-card">
                <h3>2024ë…„ë„ íŒŒì´ ì°¨íŠ¸</h3>
                <canvas id="pieChart2024"></canvas>
            </div>
        </div>
        
        <!-- ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸ (ì‹œêµ°êµ¬ë³„ ìœ„íƒë³‘ì›í˜„í™© í˜„í™© 1) -->
        <div class="bar-chart-container">
            <h3>ì‹œêµ°êµ¬ë³„ ìœ„íƒë³‘ì›í˜„í™© í˜„í™© 1</h3>
            <canvas id="yearlyBarChart"></canvas>
        </div>
    </div>

    <div class="hospitals-container">
        <div class="hospitals-list">
            <div class="list-header">
                <h3>ë³‘ì› ëª©ë¡</h3>
                <span class="hospital-count">ì´ {{ hospitals|length }}ê°œ ë³‘ì›</span>
            </div>
            
            <div id="hospitalsList" class="hospitals-grid">
                {% for hospital in hospitals %}
                <div class="hospital-card" data-hospital-id="{{ hospital.hospital_id }}">
                    <div class="hospital-info">
                        <h4>{{ hospital.name }}</h4>
                        <p class="address">{{ hospital.address }}</p>
                        <div class="departments">
                            {% for dept in hospital.medical_departments %}
                                <span class="dept-tag">{{ dept }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="hospital-actions">
                        <button class="btn-small btn-view" onclick="viewHospital({{ hospital.hospital_id }})">
                            ë³´ê¸°
                        </button>
                        <button class="btn-small btn-edit" onclick="editHospital({{ hospital.hospital_id }})">
                            í¸ì§‘
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteHospital({{ hospital.hospital_id }})">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="map-container">
            <div id="hospitalMap" style="height: 600px;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/hospitals.js"></script>
<script>
// Grafana ìŠ¤íƒ€ì¼ ì°¨íŠ¸ ìƒì„± (testdb.ìœ„íƒë³‘ì›í˜„í™©_ì—°ë„ë³„í˜„í™© ì°¸ì¡°)
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // APIì—ì„œ ì—°ë„ë³„ í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/statistics/yearly');
        const result = await response.json();
        
        if (!result.success) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.error);
            return;
        }
        
        const data = result.data;
        console.log('ğŸ“Š ì—°ë„ë³„ ë°ì´í„°:', data);
        
        // ë°ì´í„° ê°€ê³µ
        const provinceYearData = {};
        const years = ['2022ë…„12ì›”', '2023ë…„12ì›”', '2024ë…„12ì›”'];
        
        data.forEach(row => {
            const province = row['ê´‘ì—­ì§€ìì²´'];
            if (!province) return;
            
            provinceYearData[province] = {
                '2022ë…„12ì›”': parseInt(row['2022ë…„12ì›”'] || 0),
                '2023ë…„12ì›”': parseInt(row['2023ë…„12ì›”'] || 0),
                '2024ë…„12ì›”': parseInt(row['2024ë…„12ì›”'] || 0)
            };
        });
        
        // ì‹œë„ ì •ë ¬
        const provinces = Object.keys(provinceYearData).sort((a, b) => {
            const sumA = Object.values(provinceYearData[a]).reduce((sum, val) => sum + val, 0);
            const sumB = Object.values(provinceYearData[b]).reduce((sum, val) => sum + val, 0);
            return sumB - sumA;
        });
        
        // === íŒŒì´ ì°¨íŠ¸ ìƒ‰ìƒ (Grafana ìŠ¤íƒ€ì¼) ===
        const pieColors = [
            '#FADE2A', '#73BF69', '#F2495C', '#5794F2', '#B877D9', '#FFA500',
            '#FF69B4', '#1E90FF', '#32CD32', '#FFD700', '#FF6347', '#4682B4',
            '#9370DB', '#20B2AA', '#FF4500', '#00CED1', '#FFB6C1'
        ];
        
        // === 1. íŒŒì´ ì°¨íŠ¸ 3ê°œ ìƒì„± ===
        years.forEach((year, yearIndex) => {
            const canvasId = `pieChart${year.substring(0, 4)}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const yearData = provinces.map(p => provinceYearData[p][year]);
            const total = yearData.reduce((sum, val) => sum + val, 0);
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: provinces,
                    datasets: [{
                        data: yearData,
                        backgroundColor: pieColors,
                        borderColor: '#181B1F',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(23, 23, 23, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#d8d9da',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}ê°œ (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        });
        
        // === 2. ê°€ë¡œ ë§‰ëŒ€ ì°¨íŠ¸ (ì‹œêµ°êµ¬ë³„ ìœ„íƒë³‘ì›í˜„í™© í˜„í™© 1) ===
        const barColors = [
            { bg: 'rgba(115, 191, 105, 0.8)', border: 'rgba(115, 191, 105, 1)' },  // ì´ˆë¡
            { bg: 'rgba(250, 222, 42, 0.8)', border: 'rgba(250, 222, 42, 1)' },     // ë…¸ë‘
            { bg: 'rgba(82, 148, 226, 0.8)', border: 'rgba(82, 148, 226, 1)' }      // íŒŒë‘
        ];
        
        const datasets = years.map((year, index) => ({
            label: `SUM(${year})`,
            data: provinces.map(province => provinceYearData[province][year] || 0),
            backgroundColor: barColors[index].bg,
            borderColor: barColors[index].border,
            borderWidth: 0,
            barThickness: 8
        }));
        
        const barCtx = document.getElementById('yearlyBarChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: provinces,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { left: 10, right: 20, top: 10, bottom: 10 }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: '#d8d9da',
                            font: { size: 11, family: 'Roboto, sans-serif' },
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(23, 23, 23, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#d8d9da',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => context.dataset.label + ': ' + context.parsed.x + 'ê°œ'
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(128, 128, 128, 0.15)', drawBorder: false },
                        ticks: { color: '#d8d9da', font: { size: 11 }, stepSize: 20 },
                        border: { display: false }
                    },
                    y: {
                        grid: { display: false, drawBorder: false },
                        ticks: { color: '#d8d9da', font: { size: 12, weight: '500' }, padding: 8 },
                        border: { display: false }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
        
        console.log('âœ… Grafana ìŠ¤íƒ€ì¼ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!');
    } catch (error) {
        console.error('âŒ ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
    }
});
</script>
{% endblock %}