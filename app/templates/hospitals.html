{% extends "base.html" %}

{% block title %}ë³‘ì› ëª©ë¡ - ë³´í›ˆ ë³‘ì› ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block content %}
<div class="hospitals-page">
    <!-- ì—°ë„ë³„, ì§€ìì²´ë³„ ìœ„íƒë³‘ì›ìˆ˜ í˜„í™© ì°¨íŠ¸ -->
    <div class="chart-section">
        <h2>ğŸ“Š ì—°ë„ë³„, ì§€ìì²´ë³„ ìœ„íƒë³‘ì›ìˆ˜ í˜„í™© </h2>
        <div class="chart-container">
            <canvas id="yearlyChart"></canvas>
        </div>
    </div>

    <div class="hospitals-container">
        <div class="hospitals-list">
            <div class="list-header">
                <h3>ë³‘ì› ëª©ë¡</h3>
                <span class="hospital-count">ì´ {{ hospitals|length }}ê°œ ë³‘ì›</span>
            </div>
            
            <div id="hospitalsList" class="hospitals-grid">
                {% for hospital in hospitals %}
                <div class="hospital-card" data-hospital-id="{{ hospital.hospital_id }}">
                    <div class="hospital-info">
                        <h4>{{ hospital.name }}</h4>
                        <p class="address">{{ hospital.address }}</p>
                        <div class="departments">
                            {% for dept in hospital.medical_departments %}
                                <span class="dept-tag">{{ dept }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="hospital-actions">
                        <button class="btn-small btn-view" onclick="viewHospital({{ hospital.hospital_id }})">
                            ë³´ê¸°
                        </button>
                        <button class="btn-small btn-edit" onclick="editHospital({{ hospital.hospital_id }})">
                            í¸ì§‘
                        </button>
                        <button class="btn-small btn-delete" onclick="deleteHospital({{ hospital.hospital_id }})">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="map-container">
            <div id="hospitalMap" style="height: 600px;"></div>
        </div>
    </div>
</div>

<!-- ë³‘ì› ì¶”ê°€/í¸ì§‘ ëª¨ë‹¬ -->
<div id="hospitalModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ìƒˆ ë³‘ì› ì¶”ê°€</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="hospitalForm">
            <div class="form-group">
                <label for="hospitalName">ë³‘ì›ëª…</label>
                <input type="text" id="hospitalName" name="name" required>
            </div>
            <div class="form-group">
                <label for="hospitalAddress">ì£¼ì†Œ</label>
                <input type="text" id="hospitalAddress" name="address" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="hospitalLat">ìœ„ë„</label>
                    <input type="number" id="hospitalLat" name="latitude" step="any">
                </div>
                <div class="form-group">
                    <label for="hospitalLng">ê²½ë„</label>
                    <input type="number" id="hospitalLng" name="longitude" step="any">
                </div>
            </div>
            <div class="form-group">
                <label for="hospitalDepts">ì§„ë£Œê³¼ëª© (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <input type="text" id="hospitalDepts" name="medical_departments" 
                       placeholder="ë‚´ê³¼, ì™¸ê³¼, ì •í˜•ì™¸ê³¼">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/hospitals.js"></script>
<script>
// ì—°ë„ë³„, ì§€ìì²´ë³„ ìœ„íƒë³‘ì›ìˆ˜ í˜„í™© ì°¨íŠ¸ (Grafana ìŠ¤íƒ€ì¼)
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // APIì—ì„œ ì—°ë„ë³„ í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/statistics/yearly');
        const result = await response.json();
        
        if (!result.success) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.error);
            return;
        }
        
        const data = result.data;
        console.log('ì—°ë„ë³„ ë°ì´í„°:', data);
        
        // ë°ì´í„° ê°€ê³µ (ì‹œë„ë³„, ì—°ë„ë³„ë¡œ ê·¸ë£¹í™”)
        const provinceYearData = {};
        const years = ['2022ë…„12ì›”', '2023ë…„12ì›”', '2024ë…„12ì›”'];
        
        data.forEach(row => {
            const province = row['ê´‘ì—­ì§€ìì²´'];
            if (!province) return;
            
            provinceYearData[province] = {
                '2022ë…„12ì›”': parseInt(row['2022ë…„12ì›”'] || 0),
                '2023ë…„12ì›”': parseInt(row['2023ë…„12ì›”'] || 0),
                '2024ë…„12ì›”': parseInt(row['2024ë…„12ì›”'] || 0)
            };
        });
        
        // ì‹œë„ ì •ë ¬ (ë³‘ì› ìˆ˜ í•©ê³„ ê¸°ì¤€)
        const provinces = Object.keys(provinceYearData).sort((a, b) => {
            const sumA = Object.values(provinceYearData[a]).reduce((sum, val) => sum + val, 0);
            const sumB = Object.values(provinceYearData[b]).reduce((sum, val) => sum + val, 0);
            return sumB - sumA;
        }).slice(0, 17); // ìƒìœ„ 17ê°œ ì‹œë„
        
        // ë°ì´í„°ì…‹ ìƒì„±
        const colors = [
            { bg: 'rgba(115, 191, 105, 0.8)', border: 'rgba(115, 191, 105, 1)' },  // ì´ˆë¡
            { bg: 'rgba(250, 222, 42, 0.8)', border: 'rgba(250, 222, 42, 1)' },     // ë…¸ë‘
            { bg: 'rgba(82, 148, 226, 0.8)', border: 'rgba(82, 148, 226, 1)' }      // íŒŒë‘
        ];
        
        const datasets = years.map((year, index) => ({
            label: `SUM(${year})`,
            data: provinces.map(province => provinceYearData[province][year] || 0),
            backgroundColor: colors[index % colors.length].bg,
            borderColor: colors[index % colors.length].border,
            borderWidth: 0,
            barThickness: 8
        }));
        
        // ì°¨íŠ¸ ìƒì„± (Grafana ìŠ¤íƒ€ì¼ - ê°€ë¡œ ë§‰ëŒ€)
        const ctx = document.getElementById('yearlyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: provinces,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { left: 10, right: 20, top: 10, bottom: 10 }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: '#d8d9da',
                            font: { size: 11, family: 'Roboto, sans-serif' },
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(23, 23, 23, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#d8d9da',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => context.dataset.label + ': ' + context.parsed.x + 'ê°œ'
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(128, 128, 128, 0.15)', drawBorder: false },
                        ticks: { color: '#d8d9da', font: { size: 11 }, stepSize: 20 },
                        border: { display: false }
                    },
                    y: {
                        grid: { display: false, drawBorder: false },
                        ticks: { color: '#d8d9da', font: { size: 12, weight: '500' }, padding: 8 },
                        border: { display: false }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    } catch (error) {
        console.error('ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
    }
});
</script>
{% endblock %}